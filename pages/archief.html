<!DOCTYPE html>
<html lang="nl">
<head>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#1f2937">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Archief Leerlingen</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="page">
    <h2>Archief van Leerlingen</h2>
    <ul id="leerlingList"></ul>
  </div>

  <script>
    // ==== IndexedDB openen ====
    let db;
    function openDB() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open("KruisingaDB", 2);
        request.onupgradeneeded = (event) => {
          const db = event.target.result;

          if (!db.objectStoreNames.contains("leerlingen")) {
            db.createObjectStore("leerlingen", {
              keyPath: "id",
              autoIncrement: true
            });
          }

          if (!db.objectStoreNames.contains("notes")) {
            const notesStore = db.createObjectStore("notes", {
              keyPath: "id",
              autoIncrement: true
            });

            notesStore.createIndex("leerling_id", "leerling_id", { unique: false });
          }
        };
        request.onsuccess = () => {
          db = request.result;
          resolve(db);
        };
        request.onerror = () => reject(request.error);
      });
    }

    // ==== Encrypt / Decrypt helpers met vaste key ====
    const APP_KEY = "tSrOLboXzoLGawI3CfjNtK3v5VGFWtGh";

    async function getKey() {
      const enc = new TextEncoder();
      const keyMaterial = await crypto.subtle.importKey(
        "raw",
        enc.encode(APP_KEY),
        "PBKDF2",
        false,
        ["deriveKey"]
      );
      return crypto.subtle.deriveKey(
        { name: "PBKDF2", salt: enc.encode("rijschool-salt"), iterations: 100000, hash: "SHA-256" },
        keyMaterial,
        { name: "AES-GCM", length: 256 },
        true,
        ["encrypt","decrypt"]
      );
    }

    async function decrypt(encryptedArray, ivArray) {
      const key = await getKey();
      const encrypted = new Uint8Array(encryptedArray);
      const iv = new Uint8Array(ivArray);
      const dec = new TextDecoder();
      const decrypted = await crypto.subtle.decrypt({ name: "AES-GCM", iv }, key, encrypted);
      return dec.decode(decrypted);
    }

    // ==== Leerlingen ophalen uit DB ====
    async function getAllLeerlingen() {
      const tx = db.transaction("leerlingen", "readonly");
      const store = tx.objectStore("leerlingen");
      const request = store.getAll();

      return new Promise((resolve, reject) => {
        request.onsuccess = async () => {
          const rawLeerlingen = request.result;

          // De velden die encrypted zijn decrypten
          const leerlingen = [];
          for (const l of rawLeerlingen) {
            leerlingen.push({
              id: l.id,
              Voornaam: l.Voornaam,
              Achternaam: l.Achternaam,
              CBRnummer: l.CBRnummer,
              Actief: l.Actief
            });
          }
          resolve(leerlingen);
        };
        request.onerror = () => reject(request.error);
      });
    }

    // ==== Lijst renderen ====
    async function renderList() {
      await openDB();
      const leerlingen = await getAllLeerlingen();
      const listEl = document.getElementById("leerlingList");

      if (leerlingen.length === 0) {
        listEl.innerHTML = "<li>Geen leerlingen gevonden</li>";
        return;
      }

      leerlingen.forEach(l => {
        const li = document.createElement("li");
        li.textContent = `${l.Voornaam} ${l.Achternaam} (CBR: ${l.CBRnummer})`;
        li.style.cursor = "pointer";
        li.addEventListener("click", () => {
          // ga naar profielpagina met leerling ID als query param
          window.location.href = `profile.html?id=${l.id}`;
        });

        // Optioneel: stijl gearchiveerde leerlingen
        if (!l.Actief) li.style.opacity = "0.5";

        listEl.appendChild(li);
      });
    }
    window.addEventListener("DOMContentLoaded", async () => {
      await openDB();
      await renderList();
    });
  </script>
  <a href="../index.html"><button type = "button" class="homebuttons">Terug</button></a>
</body>
</html>