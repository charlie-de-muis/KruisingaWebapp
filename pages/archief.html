<!DOCTYPE html>
<html lang="nl">
<head>
  <link rel="manifest" href="../manifest.json">
  <meta name="theme-color" content="#1f2937">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Archief Leerlingen</title>
  <link rel="stylesheet" href="style.css">
<style>
/* Zorg dat alleen deze page netjes gecentreerd staat */
.page {
  margin: 0 auto;
  max-width: 500px;   /* bepaalt hoe breed het blok mag zijn */
  width: 100%;
}

/* Titel blijft gecentreerd */
.page h2 {
  text-align: center;
}

/* Lijst netjes onder de titel */
#leerlingList {
  list-style: none;
  padding: 0;
  margin: 1em 0 0 0;
}

/* Elke regel: emoji + tekst */
#leerlingList li {
  display: flex;
  align-items: center;
  gap: 1em;
  margin-bottom: 8px;
  cursor: pointer;
}

/* Emoji */
#leerlingList li::before {
  content: "ðŸš™ðŸ’¨";
  font-size: 1.2em;
  flex-shrink: 0;
}

/* Naam */
#leerlingList li span.naam {
  font-weight: 500;
}

/* CBR nummer */
#leerlingList li span.cbr {
  color: var(--kruisingablauw);
  font-weight: 500;
}
</style>
</head>
<body>
  <div class="page">
    <h2>Archief van Leerlingen</h2>
    <ul id="leerlingList"></ul>
  </div>

  <script>
    // ==== IndexedDB openen ====
    let db;
    function openDB() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open("KruisingaDB", 3);
        request.onupgradeneeded = (event) => {
          const db = event.target.result;

          if (!db.objectStoreNames.contains("leerlingen")) {
            db.createObjectStore("leerlingen", {
              keyPath: "id",
              autoIncrement: true
            });
          }

          if (!db.objectStoreNames.contains("notes")) {
            const notesStore = db.createObjectStore("notes", {
              keyPath: "id",
              autoIncrement: true
            });

            notesStore.createIndex("leerling_id", "leerling_id", { unique: false });
          }

          if (!db.objectStoreNames.contains("leskaarten")) {
            const store = db.createObjectStore("leskaarten", {
              keyPath: "id",
              autoIncrement: true
            });

            store.createIndex("leerling_id", "leerling_id", { unique: true });
          }
        };
        request.onsuccess = () => {
          db = request.result;
          resolve(db);
        };
        request.onerror = () => reject(request.error);
      });
    }

    // ==== Encrypt / Decrypt helpers met vaste key ====
    const APP_KEY = "tSrOLboXzoLGawI3CfjNtK3v5VGFWtGh";

    async function getKey() {
      const enc = new TextEncoder();
      const keyMaterial = await crypto.subtle.importKey(
        "raw",
        enc.encode(APP_KEY),
        "PBKDF2",
        false,
        ["deriveKey"]
      );
      return crypto.subtle.deriveKey(
        { name: "PBKDF2", salt: enc.encode("rijschool-salt"), iterations: 100000, hash: "SHA-256" },
        keyMaterial,
        { name: "AES-GCM", length: 256 },
        true,
        ["encrypt","decrypt"]
      );
    }

    async function decrypt(encryptedArray, ivArray) {
      const key = await getKey();
      const encrypted = new Uint8Array(encryptedArray);
      const iv = new Uint8Array(ivArray);
      const dec = new TextDecoder();
      const decrypted = await crypto.subtle.decrypt({ name: "AES-GCM", iv }, key, encrypted);
      return dec.decode(decrypted);
    }

    // ==== Leerlingen ophalen uit DB ====
    async function getAllLeerlingen() {
      const tx = db.transaction("leerlingen", "readonly");
      const store = tx.objectStore("leerlingen");
      const request = store.getAll();

      return new Promise((resolve, reject) => {
        request.onsuccess = async () => {
          const rawLeerlingen = request.result;

          // De velden die encrypted zijn decrypten
          const leerlingen = [];
          for (const l of rawLeerlingen) {
            leerlingen.push({
              id: l.id,
              Voornaam: l.Voornaam,
              Achternaam: l.Achternaam,
              CBRnummer: l.CBRnummer,
              Actief: l.Actief
            });
          }
          resolve(leerlingen);
        };
        request.onerror = () => reject(request.error);
      });
    }

    // ==== Lijst renderen ====
    async function renderList() {
      await openDB();
      const leerlingen = await getAllLeerlingen();
      const listEl = document.getElementById("leerlingList");

      if (leerlingen.length === 0) {
        listEl.innerHTML = "<li>Geen leerlingen gevonden</li>";
        return;
      }

      leerlingen.forEach(l => {
        const li = document.createElement("li");

        // Naam
        const naamSpan = document.createElement("span");
        naamSpan.textContent = `${l.Voornaam} ${l.Achternaam}`;
        naamSpan.classList.add("naam");

        // CBR nummer
        const cbrSpan = document.createElement("span");
        cbrSpan.textContent = `CBR: ${l.CBRnummer}`;
        cbrSpan.classList.add("cbr");

        li.appendChild(naamSpan);
        li.appendChild(cbrSpan);

        if (!l.Actief) li.style.opacity = "0.5";
        li.addEventListener("click", () => {
          window.location.href = `profile.html?id=${l.id}`;
        });

        listEl.appendChild(li);
      });
    }
    window.addEventListener("DOMContentLoaded", async () => {
      await openDB();
      await renderList();
    });
  </script>
  <a href="../index.html"><button type = "button" class="homebuttons">Terug</button></a>
</body>
</html>