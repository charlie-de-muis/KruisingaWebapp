<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Backup</title>
<link rel="stylesheet" href="style.css">
</head>
<body>
<h2>Backup en Restore</h2>

<button id="downloadBackup">Download backup</button>
<input type="file" id="uploadFile" style="display:none" />
<button id="uploadBackupBtn">Upload backup</button>
<button class="homebuttons" onclick="window.history.back()">Terug</button>

<script>
let db;

// Open DB
function openDB() {
  return new Promise((resolve, reject) => {
    const request = indexedDB.open("KruisingaDB", 3);

    request.onupgradeneeded = (event) => {
      const db = event.target.result;

      if (!db.objectStoreNames.contains("leerlingen")) {
        db.createObjectStore("leerlingen", { keyPath: "id", autoIncrement: true });
      }
      if (!db.objectStoreNames.contains("notes")) {
        const store = db.createObjectStore("notes", { keyPath: "id", autoIncrement: true });
        store.createIndex("leerling_id", "leerling_id", { unique: false });
      }
      if (!db.objectStoreNames.contains("leskaarten")) {
        const store = db.createObjectStore("leskaarten", { keyPath: "id", autoIncrement: true });
        store.createIndex("leerling_id", "leerling_id", { unique: true });
      }
    };

    request.onsuccess = () => { db = request.result; resolve(db); };
    request.onerror = () => reject(request.error);
  });
}

// ===== Download backup =====
async function downloadBackup() {
  const db = await openDB();
  const backup = {};

  for (const storeName of db.objectStoreNames) {
    const tx = db.transaction(storeName, "readonly");
    const store = tx.objectStore(storeName);

    backup[storeName] = await new Promise((res, rej) => {
      const all = store.getAll();
      all.onsuccess = () => res(all.result);
      all.onerror = () => rej(all.error);
    });
  }

  const blob = new Blob([JSON.stringify(backup, null, 2)], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "KruisingaDB_backup.json";
  a.click();
  URL.revokeObjectURL(url);
}

// ===== Upload backup =====
async function uploadBackup(file) {
  const text = await file.text();
  const data = JSON.parse(text);

  const db = await openDB();

  for (const storeName of Object.keys(data)) {
    // maak store aan als deze ontbreekt
    if (!db.objectStoreNames.contains(storeName)) {
      const version = db.version + 1;
      db.close();
      db = await new Promise((resolve, reject) => {
        const request = indexedDB.open("KruisingaDB", version);
        request.onupgradeneeded = (event) => {
          const db = event.target.result;
          if (!db.objectStoreNames.contains(storeName)) {
            db.createObjectStore(storeName, { keyPath: "id", autoIncrement: true });
          }
        };
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
      });
    }

    const tx = db.transaction(storeName, "readwrite");
    const store = tx.objectStore(storeName);
    store.clear(); // alles leegmaken

    for (const item of data[storeName]) {
      store.put(item);
    }

    await new Promise(res => tx.oncomplete = res);
  }

  alert("Backup succesvol teruggezet!");
}

// ===== Events =====
document.getElementById("downloadBackup").addEventListener("click", downloadBackup);
document.getElementById("uploadBackupBtn").addEventListener("click", () => {
  document.getElementById("uploadFile").click();
});
document.getElementById("uploadFile").addEventListener("change", (e) => {
  const file = e.target.files[0];
  if (file) uploadBackup(file);
});
</script>
</body>
</html>