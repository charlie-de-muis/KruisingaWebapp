<!DOCTYPE html>
<html lang="nl">
<head>
  <link rel="manifest" href="../manifest.json">
  <meta name="theme-color" content="#1f2937">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Notes</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .note {
      border: 1px solid #ddd;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 6px;
      background: #fff;
    }

    .note h4 {
      margin: 0 0 6px 0;
    }

    textarea {
      width: 100%;
      height: 100px;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>

<div class="page">

  <h2 id="pageTitle" style="color: var(--kruisingablauw);"></h2>

  <div id="notesList"></div>

  <hr>

  <h3>Nieuwe notitie</h3>
  <textarea id="noteText"></textarea>
  <button id="saveNote">Opslaan</button>

  <br><br>
  <a href="../index.html"><button type = "button" class="homebuttons">Home</button></a>
  <button class="homebuttons" onclick="window.history.back()">Terug</button>
</div>

<script>
let db;

function openDB() {
  return new Promise((resolve, reject) => {
    const request = indexedDB.open("KruisingaDB", 3);

        request.onupgradeneeded = (event) => {
          const db = event.target.result;

          if (!db.objectStoreNames.contains("leerlingen")) {
            db.createObjectStore("leerlingen", {
              keyPath: "id",
              autoIncrement: true
            });
          }

          if (!db.objectStoreNames.contains("notes")) {
            const notesStore = db.createObjectStore("notes", {
              keyPath: "id",
              autoIncrement: true
            });

            notesStore.createIndex("leerling_id", "leerling_id", { unique: false });
          }

          if (!db.objectStoreNames.contains("leskaarten")) {
            const store = db.createObjectStore("leskaarten", {
              keyPath: "id",
              autoIncrement: true
            });

            store.createIndex("leerling_id", "leerling_id", { unique: true });
          }
        };

    request.onsuccess = () => {
      db = request.result;
      resolve(db);
    };

    request.onerror = () => reject(request.error);
  });
}

function getLeerlingId() {
  const params = new URLSearchParams(window.location.search);
  return Number(params.get("leerling_id"));
}

function formatDate(date) {
  const d = new Date(date);
  const dd = String(d.getDate()).padStart(2, "0");
  const mm = String(d.getMonth() + 1).padStart(2, "0");
  const yyyy = d.getFullYear();
  return `${dd}-${mm}-${yyyy}`;
}

async function loadNotes() {
  const leerlingId = getLeerlingId();
  const tx = db.transaction("notes", "readonly");
  const store = tx.objectStore("notes");
  const index = store.index("leerling_id");

  const request = index.getAll(leerlingId);

  request.onsuccess = () => {
    const notes = request.result.sort((a,b) => b.created_at - a.created_at);

    const container = document.getElementById("notesList");
    container.innerHTML = "";

    if (notes.length === 0) {
      container.innerHTML = "<p>Geen notities gevonden.</p>";
      return;
    }

    notes.forEach(note => {
      container.innerHTML += `
        <div class="note">
          <h4>${formatDate(note.created_at)}</h4>
          <p>${note.text}</p>
        </div>
      `;
    });
  };
}

async function setTitel() {
  const leerlingId = getLeerlingId();

  const tx = db.transaction("leerlingen", "readonly");
  const store = tx.objectStore("leerlingen");
  const request = store.get(leerlingId);

  request.onsuccess = () => {
    const leerling = request.result;
    if (!leerling) return;

    const naam = leerling.Voornaam + " " + leerling.Achternaam;
    document.getElementById("pageTitle").textContent =
      "Notities: " + naam;
  };
}

function saveNote() {
  const leerlingId = getLeerlingId();
  const text = document.getElementById("noteText").value.trim();

  if (!text) {
    alert("Voer eerst een notitie in.");
    return;
  }

  const tx = db.transaction("notes", "readwrite");
  const store = tx.objectStore("notes");

  store.add({
    leerling_id: leerlingId,
    text: text,
    created_at: Date.now()
  });

  tx.oncomplete = () => {
    document.getElementById("noteText").value = "";
    loadNotes();
  };
}

document.addEventListener("DOMContentLoaded", async () => {
  await openDB();
  await setTitel();
  loadNotes();
  document.getElementById("saveNote").addEventListener("click", saveNote);
});
</script>

</body>
</html>